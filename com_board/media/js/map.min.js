/*
 * @package    Bulletin Board Component
 * @version    1.0.1
 * @author     Nerudas  - nerudas.ru
 * @copyright  Copyright (c) 2013 - 2018 Nerudas. All rights reserved.
 * @license    GNU/GPL license: http://www.gnu.org/copyleft/gpl.html
 * @link       https://nerudas.ru
 */

(function(a){a(document).ready(function(){var f=a("[data-board-map]"),i=f.attr("id"),j=a("[data-afterInit]"),h=a('[data-afterInit="show"]'),d=a('[data-afterInit="hide"]');h.hide();d.show();var c=localStorage.getItem("map"),e=Joomla.getOptions("boardMap","");if(c){c=a.parseJSON(c)}else{c={latitude:e.latitude,longitude:e.longitude,center:e.center,zoom:e.zoom};localStorage.setItem("map",JSON.stringify(c))}var g=setInterval(function(){if(a(f).width()>0&&a(f).height()>0){clearInterval(g);b()}},3);function b(){var k={center:c.center,zoom:c.zoom};ymaps.ready(function(){var E=new ymaps.Map(i,{center:k.center,zoom:k.zoom,controls:[]});E.behaviors.disable("dblClickZoom");var C={clusterize:true,clusterDisableClickZoom:true,clusterOpenBalloonOnClick:false,clusterBalloonPanelMaxMapArea:0,preset:"islands#invertedBlackClusterIcons",gridSize:e.cluster.gridSize,minClusterSize:e.cluster.minClusterSize,clusterIcons:e.cluster.clusterIcons,clusterIconContentLayout:ymaps.templateLayoutFactory.createClass('<div data-board-cluster="$[id]" style="color: '+e.cluster.numberColor+'">$[properties.iconContent]</div>')};var x=new ymaps.ObjectManager(C);E.geoObjects.add(x);var l=0,F=0,H=false,q=false,o=[],z=a('[data-board-itemlist="items"]'),I=a('[data-board-itemlist="container"]'),v=a('[data-board-itemlist="back"]'),r=a('[data-board-itemlist="close"]'),u=a('[data-board-counter="current"]'),B=a('[data-board-counter="total"]');function D(){if(H){H.abort()}if(q){q.abort()}a(v).hide();a(z).html("");a(u).text(0);a(B).text(0);x.removeAll();l=0;F=0;t();n()}function n(){var J=a(y).serializeArray();J.push({name:"map",value:1});J.push({name:"filter[category]",value:e.catid});J.push({name:"layout",value:e.layout});a.each(w,function(K,L){J.push({name:"filter[coordinates]["+K+"]",value:L})});if(l==0){a(u).text(0);H=a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_board&task=map.getItemsTotal",data:J,success:function(K){var L=K.data;l=L;a(B).text(L);if(L>0){n()}}})}if(l>0){J.push({name:"limitstart",value:F});q=a.ajax({type:"GET",dataType:"json",url:"/index.php?option=com_board&task=map.getItems",data:J,success:function(L){if(L.success){var M=L.data,K=M.placemarks;a.each(K,function(P,O){var N={type:"Feature",id:O.id,geometry:{type:"Point",coordinates:a.parseJSON(O.coordinates)},options:{}};a.each(O.options,function(R,S){if(R=="customLayout"){R="iconLayout";if(a.inArray(O.id*1,o)!==-1){var T=a(S).clone(),Q="";T.filter("[data-board-placemark]").attr("data-viewed","true");a.each(T,function(U){Q+=T[U].outerHTML});S=Q}S=ymaps.templateLayoutFactory.createClass(S)}N.options[R]=S});x.add(N)});a(M.html).appendTo(a(z));if(a('[data-board-item][data-show="true"]').length>0){a('[data-board-item][data-show="false"]').hide()}F=F+M.count;a(u).text(F);if(F<l){n()}}}})}}var y=a("[data-board-filter]");a(y).on("submit",function(){D();return false});x.objects.events.add("click",function(L){var J=L.get("objectId"),K=x.objects.getById(J),M=K.id*1;a('[data-board-placemark="'+M+'"]').attr("data-viewed","true");if(!a(I).is(":visible")){a(I).show("slow")}o.push(M);m([M])});x.clusters.events.add("click",function(N){var K=N.get("objectId"),J=x.clusters.getById(K),L=J.features,M=[];a('[data-board-cluster="'+K+'"]').closest('[class*="default-cluster"]').css("opacity",e.cluster.clickOpacity);a.each(L,function(P,O){var Q=O.id*1;M.push(Q);o.push(Q)});if(!a(I).is(":visible")){a(I).show("slow")}m(M)});function m(K){var J=a("[data-board-item]");a.each(J,function(L,M){var N=a(M).data("board-item");if(a.inArray(N,K)==-1){a(M).hide();a(M).attr("data-show","false")}else{a(M).show();a(M).attr("data-show","true")}});v.show()}a("body").on("click","[data-board-show]",function(){var L=a(this),P=a(L).data("board-show"),M=x.getObjectState(P),K=a('[data-board-placemark="'+P+'"]');if(M.isClustered){var J=M.cluster;K=a('[data-board-cluster="'+J.id+'"]').closest('[class*="default-cluster"]')}var O=1.4,N=350;a({scale:1}).animate({scale:O},{duration:N,step:function(Q){K.css("transform","scale("+Q+")")}},"linear");setTimeout(function(){a({scale:O}).animate({scale:1},{duration:N,step:function(Q){K.css("transform","scale("+Q+")")}},"linear")},N);m([P])});a(v).on("click",function(){var J=a("[data-board-item]");a(J).show();a(J).attr("data-show","false");v.hide()});a(r).on("click",function(){a(I).hide("slow")});var w={north:90,south:-90,west:-180,east:180};function t(){var O=E.options.get("projection"),J=E.getGlobalPixelCenter(),T=E.getZoom(),U=E.container.getSize();var N=O.fromGlobalPixels([J[0]-U[0]/2,J[1]+U[1]/2],T);var M=O.fromGlobalPixels([J[0]+U[0]/2,J[1]-U[1]/2],T);var R=E.getBounds(),K=[N,M];var L=K[1][0],P=K[0][0],S=-180,Q=180;if(R[0][1].toFixed(6)!=R[1][1].toFixed(6)){S=K[0][1];Q=K[1][1]}w.north=L.toFixed(6);w.south=P.toFixed(6);w.west=S.toFixed(6);w.east=Q.toFixed(6)}var p=a('[data-board-map-zoom="plus"]'),s=a('[data-board-map-zoom="current"]'),A=a('[data-board-map-zoom="minus"]');a(p).on("click",function(){if(E.getZoom()!=19){E.setZoom(E.getZoom()+1,{duration:200})}});a(A).on("click",function(){if(E.getZoom()!=0){E.setZoom(E.getZoom()-1,{duration:200})}else{a(A).attr("disabled","disabled")}});function G(J){if(J<19){a(p).removeAttr("disabled")}else{a(p).attr("disabled","disabled")}if(J>0){a(A).removeAttr("disabled")}else{a(A).attr("disabled","disabled")}}G(E.getZoom());s.text(E.getZoom());a("[data-board-map-geo]").on("click",function(){ymaps.geolocation.get().then(function(K){var J=K.geoObjects.position;E.setCenter(J,15)})});E.events.add("boundschange",function(K){if(K.get("newZoom")!=K.get("oldZoom")){var J=K.get("newZoom");k.zoom=J;s.text(J);G(J)}if(K.get("newCenter")!=K.get("oldCenter")){var M=K.get("newCenter")[0].toFixed(6),L=K.get("newCenter")[1].toFixed(6);k.center=[M,L];k.latitude=M;k.longitude=L}localStorage.setItem("map",JSON.stringify(k));D()});h.show();d.hide();j.removeAttr("data-afterInit");D()})}})})(jQuery);